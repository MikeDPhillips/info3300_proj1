<!DOCTYPE html>
<html lang="en">


<head>
    <title>Project 1: Life Expectancy</title>
    <script src="https://d3js.org/d3.v6.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" media="screen"/>
<!--    <style>
        .xAxis .tick text {
            font-size: 28px;
            text-anchor: middle;
        }
    </style>-->
</head>

<body>

<div id="main_header">
<h2> Life Expectancy</h2>
</div>

<div class="header" id="g1_header">
<svg id="g1">
</svg>
</div>

<script>
    let margin = {top:20,right:20,bottom:120,left:60},
            width = 1400,
            height = 1200,
            chartWidth = width - margin.left - margin.right,
            chartHeight = height - margin.top - margin.bottom;

    let svg = d3.select("#g1")
        .attr("width", width)
        .attr("height", height)

    let annotations = svg.append("g").attr("id","annotations");
    let chartArea = svg.append("g").attr("id","points")
            .attr("transform",`translate(${margin.left},${margin.top})`);

    d3.csv("countrydata.csv", d3.autoType).then((data) => {
        console.log(data[0]);
        console.log(data[0]['2016']);

        console.log(data.length)

        const group_key = 'Region2';
        data = data.filter( d => {
            return d[group_key ] != null && d[group_key] != "NA" })
        console.log(data.length)


        data.sort( (a,b) =>
                d3.descending(a[group_key ],b[group_key ]) ||
                d3.ascending(a['2016'], b['2016']));


        // X axis
         let xScale = d3.scaleBand()
                 .domain(d3.map(data, d => d.Country))
                 .range([0, chartWidth])
                 .padding(0.00)
                 .paddingOuter(0.5);

        let groups = d3.map(data, d => d[group_key ]);
        console.log(groups);
        let xGroups = d3.scaleBand()
            .domain(groups)
            .range([0, chartWidth])

       let bottomAxis = d3.axisBottom(xGroups);
       annotations.append("g")
               .attr("class", "xAxis")
               .attr("transform",`translate(${margin.left},${chartHeight+margin.top})`)
               .call(bottomAxis)
               .selectAll("text")
               .attr("id", "xText")
               .attr("transform", "translate(0,20)rotate(10)")
               //.style("text-anchor", "end")


       // Y Axis
        let yScale = d3.scaleLinear()
            .domain([40, 90])
            .range([chartHeight, 0]);
        let leftAxis = d3.axisLeft(yScale).ticks(10);
        let leftGridLines = d3.axisLeft(yScale).ticks(10)
                .tickSize(-chartWidth).tickFormat("");

        annotations.append("g")
            .attr("class", "yAxis")
            .attr("transform",`translate(${margin.left},${margin.top})`)
            .call(leftAxis)
            //.selectAll("text")
            // .attr("transform", "translate(-10,0)rotate(-45)")
            // .style("text-anchor", "end")
            // .style("font-size", 8);

        annotations.append("g")
            .attr("class", "gridlines")
            .attr("transform","translate("+(margin.left)+","+(margin.top)+")")
            .raise()
            .call(leftGridLines);


        //Color scale
        const fillScale = d3.scaleOrdinal(d3.schemeSet2)
                .domain(d3.map(data, d => d[group_key]))

        //Add bars
        chartArea.selectAll("rect.bar").data(data)
            .join(enter => {
                console.log(d => {
                    if(d['2016'] !== d['2016'])
                        return(0);
                    else
                        return(d['2016']);
            })
            enter.append("rect")
                .attr("class", "bar")
                    .attr("region", d => d[group_key])
                .attr("x", d => xScale(d.Country) )
                .attr("y", d => yScale(d['2016']))
                .attr("width", xScale.bandwidth())
                .attr("height", d => {
                    if(d['2016'] !== d['2016'])
                        return(yScale(0));
                    else
                        return(chartHeight - yScale(d['2016']));
                })
                .attr("fill", d => fillScale(d[group_key]))
                .on("mouseover", function () {
                    let r = d3.select(this);
                    console.log(r.attr("region"));});
            },

            exit => {
                exit.remove();
            }
            );


    })

</script>


</body>
</html>
